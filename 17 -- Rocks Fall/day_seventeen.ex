defmodule DaySeventeen do
  @jet_sample "><<<<>><<<<>>>><>>><<<<>>>><<<>>><<<>>>><<>>><<<<><<<<>>>><<<>><>><>>>><<>><<<><<>><<<<>>>><<>>><<<>>>><<<<>>><<<>>><<<<>>>><<<<><>><>>><<>>>><><<>><<>>>><<>>><<<>><<<<>>><<>>>><>>>><<<>>>><<<<>><>><<<<>><>>><<>>><>>>><<<<>>><<>>><<<><<<><>><<<<>>><<<<>><<<<><<>>><>>><<>>>><<<<>>>><<<>>><<<><>>>><<<<>><<<<>><>>>><<<>>><>>>><>><<<<>>>><<<<>><<>>><<>>>><<<>><<<<><<<<><<<>>>><>>><>><<>><>>><<<>>><<<>>>><<>>>><><<<<>>><<<<>>><<<>>><>>>><<<>>><>>><<<<>><<<<>>>><><<<>>>><<<>>><<<<><<<<>>><>><<><>>>><<<<>><>><<<<>>><>>><<>>>><>>>><<<>>><<<<>>><<>>><><<>>><>>><<<>>>><>><<<><<<><>>><<><<<>>>><<<<>>><<<>><<<>><<<<>><>>><<<><<<>>><<<><<<<><<>><<><>>>><<>>><<<<><<<>>>><<><<<<>>><<>>>><<<<>><<>>>><<>>><<<><<<>><<<>>><<>><<>>><<>><<>><<<><<<<>>><><<<<>>><<<<>>><>>><<<<>><<><<<<><<<<>>>><<>><<>>><<<<>><>><<<<><>>><<<>>>><<<><<>>><<>><<>>><<<>>><<>>>><<>><<<>>>><<>>>><<>>>><><<<<><<<<><<<<>>>><>>>><<>>>><>><<<>>>><<<>>><<<<>><<<<>>>><<<<>><<<>>><<<>>>><<<>>><<<<><<<>>><<><>>>><>><>>>><<><<<<><<<<>><<<<>>>><>>>><>><<>><<<><<<><<<>><<<>>><>>>><>><<>><<<<>>>><>>>><<<<>>>><<>>><<<>><>><<>>><<<<>>>><>>>><<<<>>>><>>><<<>>>><<<>><<<<>>><<<>>><<>>><<<<>>>><<<><<<>>><<<<>><<<<><>>>><<<>>><<<<>><<>><<<<><<<<>>>><>>><><<<>>><<<>>><>><<>>><>>><><<<>><<<<>>><<<><<<>><<<<><<<<><>>>><<<><<>><>>>><<>>>><><<>><<>>>><<>>><<<<>><<<<>>>><>>><<>><<<<><<<<>>>><<>><<<>>>><<>>>><<<>>><<<>>><<<<><<>>><<<>><<<>><<<<>>><>>>><<<<>>><>>>><<<<>><<>>><<<>>>><<>><>>><<<<>>>><<<>>><<<<><>>><<><<><<>>>><<>><<>>><<<<>>><><>>><>><<<<>>>><>>>><<<><><<>>>><<<<>>><<<<>>>><>>>><<><><><>><<><<>>><<>>><<<>>>><<<><<<>><<>>>><>>>><><<<<><<<<>><<>><<><<<>>>><<<<>>>><>>><<<>>><>><><<<>>><<>>>><<<><>>>><<<>><>><<<>><<<<>>><>>>><<><<<<><<<>><<<><>>><<<<>>><<>>><<<<>><<><<<>>>><<<>><<<>>>><<><<<><>><<<><<<>><<<<><>>><<<<><>><<<><<>><<>>>><>>><>><><<<<>>><<<<>><<<>>><<><<<<>>>><<<<>><><<><<><<<><<<>>>><<>><<>>><<>><<<>>><<<<>>><<<<>><<<>>>><<<>>>><>>>><<<<><><<<<>><<>>>><>><<<<>><>>>><<>>><<<><<<>><<<>><<<>>>><<>>>><<<>>><>>>><<>>>><<>><<<<>>>><<<>>>><<><<<>>>><<>>><<>>>><>><<<<><<>>><<<>>><<<<>><<><<<>>>><>><<>>><<<><<><<<><<<><<>>><<<<>>><<<<><<><>><>>>><>>>><<<>><<<>>>><<<<>>><<>>><<>>>><<<<>>><<>>><<<<>>><<<<>>>><<<<>>><><>><<<<><<<<>>><<<>>><<<><>><>><<<<><<<<>><<><<>>>><>>>><<<>><<<<>>>><<>><<<<>>><><<>>><>>><<<><>>><<<><<<<><<<>><>>>><><<<<>>>><<><<<><<<<>><>>>><<><<<<>>><>>><<<>>><<<<><<<>>>><>>>><<<>>><<>><>>>><<>>><<><>>><<<<><<<<>>>><<>>><<>><<<>>><<><<>>>><><<<<>>><<<<><>>>><>>><<<><><<<<>><<>>><<<<>>>><><<><<<<>><<<>><<>>><><<<<><<<<><>>><<>>><>><<<>><<><<<>>>><<<>>>><<<>>>><>>>><>>>><<<><<>>>><><<<<><>>>><<<>>><<<><<<<><<<>><<><<>>><<<><><><<<>>>><<<<>>>><<>><<<>><<>>><><<<<>><<>>>><>>><<<<>><<<<>><<<>>><<<>>>><<><><<<>><<<<>><<<<>>><><>><<<<>><>>><<<<><<<><<<>><>><<<><>>>><<<><<>><<<>>>><<<<><<<<><<<>><<>>><<>>>><<>><<<>>>><<>>><<<><<>>><<>><<>>>><<<<>>><<><<<<>>>><<<<>>><<<>>><<<>>>><<>><<<<><><<<<>>>><>><>><>>><<<<>><<<<>><<><>><<<<>><<<>>><>><<<>><>>><<><<<>>>><><<<<><<<>>>><<<>><>><>><<>><<<>><<<<>>><>>>><<<>>>><<<<>>><>>>><<<<>>><>>><<>><<><<<<><<<>><<>><<<<>>><<>>><<>>><<<<>>><<<>><>>>><<<>><<<<>>>><<>>>><>>>><<<<>><>>><<>>><>>><<>>><<<><<<<><>><<<<><><<<<><>>><<<<>><<<>>><<<>><<<><<<<>>>><><>><<<>>><><<<<>><<>>><>>>><><>>>><><<<>>><<><>>>><><<<<><<<<>><<>><<<<><<<>>>><>>><<>>><>><<<<>>><<>>><<>>><<<<>>><<<><>>><><<<<>>>><<<>>>><>>>><<<<>><<<>><<<>><<<<>><<<<>>>><<><>>>><>>><>>><<<<>>><<<>>><<<<>>>><<<>>>><<>><<<<>><<<>>>><<<><<<>>><<<<><<<<>><>><<>>><><<<<>>><>><<<>>>><<>>>><<<<>>><<><<>>><<<<>>><<<>><<<<>><<>>>><<<<>>>><<<<>>>><<>>>><>>><<<>>><<<<>>>><<><<>><<<<>><<<>>>><<>><<<>>>><>>><<<<>>><><>>><<>><<<>>><<<<><<<<><<><<<<>>><<<><<<<>><<<>><>><>>><>>><<<<>>>><<<>>>><<<>>><>>><><<<<>>><<<>><<>>><<<>>><<<><<<><>><<<>>>><<<>>>><<<<><><<<>><<<>>><<<>>>><<<<>>>><<<<><>><>>><<>>><<<<><<<<>>><<><<<>>><<><<<<><<>>><<>>><>>>><<>>><><><<<><><><<>>><>><<<<>><<<<><>><<<<>>>><<><<<><<>>>><><<<<>><><>><<<<><<<>>><<><<<>><<>><<<>><<<>><<><<<>>>><>>><<<>><<>><<<<>><<<><<>>><<<<><<>>>><>><<>><<<>>><<>>>><<><><<<<><>><<>>>><><<>>>><<<>>>><<<<>>>><>>><><<<>>>><>><<<>><<<<>>><>>>><<><<<>>>><>>><<>><<<>>><<<>>>><<>>><<<><<<>>><<<<>><<<><<>>>><><<<>>>><<<<>>>><<><<<<><><<>>><<<>>><<<><<<>><<<<>>><<>><>>>><<<><>>>><<<><><>>><<<>>><<<<>><<><<<>><<>><<<<>>><<<>><<>>><<<<>>>><<<>><<<<>>>><<<><<>><<<>>>><<>>>><<<<>>><>>><<><<><<<>>><>><>>>><<<><<<><<>><<>>><>><<<><<<<>>><><<>>>><>>>><>>><<<<>><<><<<>>>><>>><<>>><<<><<<<>>><<>>><<<<>><<<><<>>>><>>>><<<>><<<<>>>><<<><>>>><<<<>>><<<<>>><<>><<>><<<<><<<<><<<<>>><>>><<<>>>><<><<<><<<<>>>><<<<>>><<<<>><<<>>>><<<<><<>>><<>><>><<>><><<<>><>>>><><<><<<>>>><<<<>>><>><<<<>>><>>><<>>>><<>>>><<<>><<>>><<><<<<>>><<>>><>>>><<<>>>><<>>><><<<>>>><<<<>>><<<<><<<<><><<><>>><><<>>><><<<<>><<<<>>><<<>><<>>>><<<<>>><<<><<<><>>><<<<><<<<><<>>><<><<>>>><<<<>>><><<><<<><<<<>>>><<><<>><><>>><<<>><<><<<<>>><<><<<<><<<<>><<>>>><<>>>><<>><<<>><>><<<>>>><>>><>>><<<>>><<<<>>><>>>><<>>><<<<>>>><<<<>>>><>>><<<><<<<>><<>>><<<>>><<>>><<><<<>>>><><<>><<>>><<<<>><>>>><<>><><<<<>>><><<<><><<>>>><<<>>><<<<>>>><<>>><<><<>>><<>><>><<>>><<<<>>>><<<<>>>><>>><<<<><<>><<<<><<>><<<>><<<<><<>>><<<<>>><<<><<<<>>>><<<<>>>><>>><<<<>>><>>><>><<<<>><<<>>><<>>>><>>>><<<<>>><>><><>>>><><>><>>><<<<>><<<<>>>><<<<><><<<>><<>>><<<>><<<><<<<>><>>>><<><<<><>>><><<<<>>><<>>>><>>>><<<>>>><<<><>>><<<>><<<<>>><<<>>><<<>>>><<>><>>><><<<<><<>>><>>>><<<>>>><>><<><<<>><<<>>><<>>>><>>><<>>>><>><<>><>>><<>><<>>>><<<<>>><<><<><<<<>>><<<>>><<><<>>><<>>>><<<>><<<>>>><>>><<>>><<<>>>><>>><>>><<><>>><<>>>><<>><>>><><<>>><<<<>>>><<<<>>><<>><<>>><<<<><>><<>>><<>>><><<<<><>><<<<><<>>><<>>>><<<<>>>><>>><<<>>>><>>><<<<>><>><>><><><>>><>><<<<><<<><<<<>>>><<><<>><>><<<>><<<<>><>>>><><<<<>>><<><>>><<<<><<<<><<<><<<>>><<<>>><>>>><<<>><<<<><<<<>>><>><<<<>>>><>>><<><<<>>>><<<>>>><<<><<<>><<>>><<<<>>><<<<>>>><<>>><>>>><>>><<<<><<>><>>><<>>><<<><<>>>><<>>><<<<><>>>><<<<>>><<><<<><<<><<<<>>><<<<>><<<<>><<<>><<<<>>>><>>><>>><<><<<<>>>><<<<>><>>><>>>><<<>><<>>>><><<>>>><<<>>>><<<>><<<>><<<<>>>><<<<><<<><<>>>><>>>><>><<><<>>><<<><<>>>><<>>><<>>>><<<<>>>><<<<><<<<>>><><>>><<<<>><<<<>><>>>><<>><>>>><<<<>>>><<<<>><<<><><<<<>>><<<<>>><>><>>><<>><<<>>><<<<>><<<<>>>><<<><<<<><<<<>>><<<<>><<<>>>><<<<>><>>><<>>>><<>>><<<<>>><<<<><<<><<<<>>>><<<>><<<>><>>>><<<<>>>><<<><<<>>>><<<><<<<>>><>>><>>>><<<>>><<<<>>><><<<>>>><<<<>><<>>>><>>><<<<>><<<<>>>><<<>>><>>><>>><<<<>><<<<>>>><<>>><<<<>><<<<>>><<<><<>><<<<>>><<<<>>>><>>>><>>><<>>>><<<<><<<>><<><<>>>><<>><<<<>><><><<<<>>>><<>><<>>><<<<>><><<<<><<<<>>>><<<>>>><<><<<<>><<>>>><<<>>><<<<><<<<><<<<>>><<<<>><><<<><<<<><<<><<>><<<<>><>>>><<<><>>>><<<<><<>>>><>><>>><<<><<><<<<>>><<<>>>><<<>>><<>><<<<><<>>><<>>><<<<>>><<<>>>><<>>>><<>>><<<>>>><>>>><<<<><<<<>>>><<<><<<><>>>><<<<><><<<><<<><<<<>><<<<>>><><<<<>>><<>>>><<><><<><<<<>>>><<><<><<<>>>><<><<>><>>><<<<><<><<<<>>>><<<><<<><<<<><>>><<<>><>>><<><<><<<>><<<><<<<><><>>><><><<<>><<<>>>><<<>><>><<>>>><>><<>><<><>><<><<<>><<<>>><<>><>><<<<>>>><<<<><<><<<>>><<<<>>><>>>><<<>><<<<>><<<<>>><><<<>><>><<<<><<<>>>><<<<>><>><<<<>><<>>>><<<<>>>><<><<<<>><<<>><>><><<<<>><>><<>>><>>><<>><<<><<>>><<>>><>>><>>>><<<>>>><<<<>><<<<>>>><><<<<><<><<<><<>>>><<>>><<<<>>><<<><<<>><>><>><<>><<<>>><><<>><<<<>>>><<>><<<<>>>><<><<<>>><<<<><<<<>>>><>>><<<<>><<<>>><<<><>><><<<>><<>>>><><<>>><<<<>><>>>><<<<><<<<>>><<<<>>>><<<>><<<<><>><><<>><<<>>><<<><>><<>>><<<<>>><<>>><>>><<<<>><<>>>><>>><>><<<>><<<>>>><<>>>><<<><<>>>><<<<><<<<><<<>><<<><<<<>>>><<<>><>>><<<>>><<<>><<<<>><<<<>>>><<<<><<>>><<>><>>><<<>><<<<><<>><<>>><<><<<><<<<>>>><<<<>>><<<>>>><>><<<><<<<>>><<<>>><<>><>><>><<<<>>>><<>>><<>><<>><>><<<<><<>><<<><<<><<<<>><>>>><<<>>><>><<<<>><<<><>>>><>><>><<><<>>><>>><>>>><<<>>><<<<><<<<><<>>><<<>>><><><<<>>><<<>>><<<<>>><><<<<>>><<<>>><>>>><<<<>>><<>>><<><<<>>>><<<>><<<<>>>><<>><>>>><<><>><<<>>>><<<<><>>>><<<>>>><<<<>>><><<><<<>><>>><<<>><<<<>>><><><<>>><<<<>><>><<<<><>>><<>>><<<<><<<<>><>>>><<><<>><<<<>>><<<>><<>>><>>>><>>>><<>>>><<<<>>><<<<><<<><><<<<>>><<>><<<>>>><<><<<>><>>><<>>>><<<<>><<><<<<>>><<>><<<<><<<>><<<>>><<>><<<<><<<<>>><<<<>><<<<>>><<>>>><<<>>><<<<>><<<<><>>>><<><<>>><<>>><<<<>><>><<<<>><<<<><<>>><<<>><<<<>>><<<>>><<<<>>>><<<<>>>><<<><>>><<>>><<>><<>>><>><<<>>><<<><>>>><<><<<>><<<<>><<<>><>><>>>><<<<><<<>>><>><>><<>>>><<<>><>>>><<>>><<>><<>><<<<>><<<>>>><>>><<<>>><>>><<<<>><<<<><>><<>>>><<<<>>>><<<<>>>><>>><<<>><<<<>>>><<>>>><<>>>><<<>><<<><<<>>><<<><>>><<<>>><<>>><<<<>>>><>>><<<<>><<<>>><<>>>><<<<><<<<><<><>><<<>><>><>><<<><<<>>><>>><><<<>>><>>>><<>>><<>>>><<>>><<<<>><<>>><<<><<><>><<<<>><>>><<<<>>>><>><<<>><<<<>>>><<><<<<>>><<<>><<<>><<<<>>><>><<<>><<<<>>>><>><<<><<>><>>><<<<>>><<<>>>><><<<><<<>>>><<>>>><<><<<><<<>>><<><<<<>>><<<<>>>><>>><><>>>><<<>>><>><<<<>>>><>>>><>><<<<>>>><<<<>>><>>>><<>>>><<><<<<><<>>>><<<>><<<>>>><<><<<>>><<><><<><<<<>>><<>>><<<>>><<<<>><<>>><<<<>><<<><<>>>><<<><>>><<>>>><<<><<<>>><<>>>><<<<>><>>><>>>><<<<>>>><<<>>>><<<>>><>><<<>>><<<<>><><<><>><><>><<>>><<>>>><<<<>>><<<>><<<>><<<><>><<<>>>><<><>><>>>><<<<>>>><<>><<><<<>><<<>><>>>><<>><<<<><<<<><<<><<<>>><<<>>><>><<<<><<<<>>><<<>>>><<>><<<<>>><<<>>><>>>><>>>><><<<<>><<>>><<>>>><<<<><<>>>><<<>>><<<>><<><<<>>>><<<>>><<<>>><><>><<<>><<<<>>>><<<<>>><<<<><<>>>><<<<><<<>>>><<<<>><<<<><>><<>>>><><>>>><<<<>>>><<<>><<<>><<<<>>><<>><<<<>><>><<>>><<<>>>><<<<>>><<<<>>><<><<<<>>>><><<>>><<>>>><<<><<><>>>><<>>>><<>><<<<><>><<>>><><<<<>>><<<<>><>>><<<>><<>>>><<>>><<<>><<><<>>><<<>>>><><><<<>><><>>>><>>><<<<><<<>>><>><<<<><<>>>><<<<>><<<><<<<>>>><>>><>><<<<>><<<<>>>><<<<>>>><<<<>>><>>><<<>>>><<<>><<>>>><<<>>>><<<<>>>><<<<>><>><<<<>><<<<>>><<<<>>><<<><<<>><<>><<<<>>>><<<<>>><<<>><>>>><<<>>>><<><>><<<<><<<<><<>>>><<>>><<<>>><<<><<>><><<<<>><>>>><>>><<<>>><><<<><<>>>><<<<>>><<>>><<>><<>><<<<>>>><<>>><>>><>><<>><<<>>><<>><>>>><<<><>><<<<>>>><><<>>>><<<><<>>><><<<<>>>><<<><<<>>><<<>>><<<<>>>><<<<>>><<<><<>>><>>><<>>>><><>>><<<<>>>><>>>><<<>>>><<<<>><<<><>>><<<<>>><>><<>>>><<>>>><<>>><<>>><<<>>>><<<<>><>>><<>>><<>><<<>>><<<><<<>><<>><>>><<<<><<<<>>><<><<<>>><<<>>><<><<<<>><><<<<>>><>><<<<><<>><<>>>><<<<><<<<>>>><<<>><<<<>>><<<<>>>><<<>>><>>><<<<>>>><<><<<><<>>><<<<><<<<>><<<<>><<<<>><<<"
  @jet_size String.length(@jet_sample)
  @floor_set MapSet.new(for x <- 0..6, do: {x, 0})
  @rounds 1_000_000_000_000

  def run(file_path \\ "test_input") do
    file_path
    |> File.read!()

    rock_round(@floor_set, 0, 0, 0)
  end

  def rock_round(_rock_set, y, shape, jet) when rem(shape, jet) == 0,
    do: [shape: shape, jet: jet, y: y]

  def rock_round(rock_set, y, shape_idx, step) do
    IO.puts("Round #{shape_idx}")
    new_rock = create_shape(shape_idx, y + 4)

    {new_rocks, new_step} = rock_movement(new_rock, step, rock_set)
    new_y = find_highest_y(new_rocks)
    rock_round(new_rocks, new_y, shape_idx + 1, new_step)
  end

  def find_highest_y(rock_set) do
    {_x, y} = Enum.max_by(rock_set, fn {_x, y} -> y end)
    y
  end

  def rock_movement(rock, step, rock_set) do
    dir = String.at(@jet_sample, rem(step, @jet_size))

    jet_rock =
      if valid_move?(rock, dir, rock_set) do
        move_rock(rock, dir)
      else
        rock
      end

    if valid_move?(jet_rock, "v", rock_set) do
      jet_rock
      |> move_rock("v")
      |> rock_movement(step + 1, rock_set)
    else
      # IO.puts("Rock settles at: ")
      # IO.inspect(jet_rock)
      # IO.gets(" ")
      {MapSet.union(rock_set, jet_rock), step + 1}
    end
  end

  def move_rock(rock, dir) do
    {dx, dy} =
      case dir do
        "<" -> {-1, 0}
        ">" -> {1, 0}
        "v" -> {0, -1}
      end

    Enum.map(rock, fn {x, y} -> {x + dx, y + dy} end) |> MapSet.new()
  end

  def valid_move?(rock, dir, rock_set) do
    # IO.puts("Rock tries to move #{dir}")

    {dx, dy} =
      case dir do
        "<" -> {-1, 0}
        ">" -> {1, 0}
        "v" -> {0, -1}
      end

    new_rock = Enum.map(rock, fn {x, y} -> {x + dx, y + dy} end) |> MapSet.new()

    result =
      MapSet.disjoint?(new_rock, rock_set) and
        not Enum.any?(new_rock, fn {x, _} -> x > 6 or x < 0 end)

    # if result do
    #   IO.puts("\tvalid")
    # else
    #   IO.puts("\tinvalid")
    # end
    #
    # if dir == "v" do
    #   IO.puts("-")
    # end

    # :timer.sleep(1_000)
    result
  end

  def create_shape(shape_idx, y) do
    # IO.puts("New rock appears at row #{y}")
    shapes = [&hor_shape/1, &cross_shape/1, &l_shape/1, &vert_shape/1, &box_shape/1]
    Enum.at(shapes, rem(shape_idx, 5)).({2, y}) |> MapSet.new()
  end

  def hor_shape({x, y}), do: [{x, y}, {x + 1, y}, {x + 2, y}, {x + 3, y}]

  def cross_shape({x, y}),
    do: [{x + 1, y}, {x + 1, y + 1}, {x + 1, y + 2}, {x, y + 1}, {x + 2, y + 1}]

  def l_shape({x, y}), do: [{x, y}, {x + 1, y}, {x + 2, y}, {x + 2, y + 1}, {x + 2, y + 2}]

  def vert_shape({x, y}), do: [{x, y}, {x, y + 1}, {x, y + 2}, {x, y + 3}]

  def box_shape({x, y}), do: [{x, y}, {x + 1, y}, {x, y + 1}, {x + 1, y + 1}]
end
